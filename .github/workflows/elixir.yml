name: Elixir CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

env:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: ryujin_test
  ELIXIR_VERSION: "1.18.4"
  OTP_VERSION: "28.0"
  DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ryujin_test

jobs:
  build:
    name: Build and test
    runs-on: ubuntu-22.04

    services:
      postgres:
        image: apache/age:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ryujin_test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Elixir and Erlang/OTP
        uses: erlef/setup-beam@v1.16.0
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
            ~/.hex
            ~/.cache/rebar3
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}-elixir-${{ env.ELIXIR_VERSION }}-otp-${{ env.OTP_VERSION }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile
        run: mix compile

      - name: Run tests
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: mix test
